<?xml version="1.0"?>
<html>
<head>
    <title>Demo UI for the Crucible Stats Facade</title>
    <link rel="stylesheet" href="css/reset.css" type="text/css" />
    <link rel="stylesheet" href="css/style.css" type="text/css" />
    <link rel="stylesheet" href="css/datatable.css" type="text/css" />
    
    <script type="text/javascript" src="js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="js/transparency.min.js"></script>
    <script type="text/javascript" src="js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="js/moment.min.js"></script>
   
    <script type="text/javascript">   
    $(function() {
        setupLoaderAnimation();
        loadCacheStatus();

        $("#update-cache").click(function (e) {
            $('#last-update-started').text(moment().format("DD.MM.YYYY HH:mm"));
            e.preventDefault();
            updateReviewCache();
        });

        loadReviewData();
        setupFilterChangeHandlers();

    });

    function loadReviewData() {
        function userstatToArray(json) { 
        	return [json.username, json.authoredreviewcount, json.commentcount, json.avgmessagelength]; 
        }
        var userstatHeaders = ["Username", "Authored Reviews", "Total Comments", "Avg Message Length"];
        setDataFromUrlToTable("/userstats", userstatToArray, "#userstats", userstatHeaders);

        function monthlystatToArray(json) { 
        	return [json.year, json.month, json.count]; 
        }
        var monthlystatHeaders = ["Year", "Month", "Review Count"];
        setDataFromUrlToTable("/reviews-per-month", monthlystatToArray, "#reviews-per-month", monthlystatHeaders);

        function reviewToArray(json) { 
        	return [json.id, json.author, json.createDate]; 
        }
        var reviewListHeaders = ["Id", "Author", "Created"];
        setDataFromUrlToTable("/reviews", reviewToArray, "#reviews", reviewListHeaders);    	
    }

    function setupFilterChangeHandlers() {
        filterNames.forEach(function(filterName) {
            $('#'+filterName).change(function() {
                destroyDatatables();
                loadReviewData();
            });
        });
    }

    function setupLoaderAnimation() {
        $('#loader').hide();
        jQuery.ajaxSetup({
            beforeSend: function() {                
                $('#loader').show();
            },
            complete: function(){
                $('#loader').hide();
            },
            success: function() {}
        });
    }

    function loadCacheStatus() {
        $.getJSON("/cache-status", function(json) {
            
            json["reviews-updated"] = moment(json["reviews-updated"]).format("DD.MM.YYYY HH:mm");
            json["comments-updated"] = moment(json["comments-updated"]).format("DD.MM.YYYY HH:mm");
            json["last-update-started"] = moment(json["last-update-started"]).format("DD.MM.YYYY HH:mm");

            $(".cache-status").render(json);
        });
    }
    
    function destroyDatatables() {
        $('#reviews-per-month').dataTable().fnDestroy();
        $('#userstats').dataTable().fnDestroy();
        $('#reviews').dataTable().fnDestroy();
    }

    function updateReviewCache() {
        var data = $("#cacheform").serialize();
        $.post("/update-cache", data, function(json) {
            loadCacheStatus();
            destroyDatatables();
	        loadReviewData();          
        });
        return false;
    }

    var filterNames = ["excludedProjects", "includedProjects", "authors", "sinceDate", "minComments"];
    function getReviewFilters() {
        filters = {};
        filterNames.forEach(function(filterName) {
            val = $('#'+filterName).val();
            if ( val > 0 || val != "" ) filters[filterName] = val;
        });
        return filters;
    }


    function setDataFromUrlToTable(url, mapper, tableid, headers) {
        $.getJSON(url, getReviewFilters(), function(json) {
            var data = json.map(mapper);
            var cols = headers.map(function(header) { return {"sTitle": header}; });

            $(tableid).dataTable({
                "aaData": data,
                "aoColumns": cols
            });
        });
    }

    </script>
</head>
<body id="statsfacade">

    <div class="wrapper cache-status">
        <h1>Cache status:</h1>
        <div>Reviews updated: <span class="reviews-updated"></span>, 
             comments updated: <span class="comments-updated"></span>,
             last update started at: <span id="last-update-started"></span>
             <span id="loader">
                 <img alt="Loading, please wait.." src="/img/ajax-loader.gif" />
             <span>
        </div>
        
        <form id="cacheform">
            <label for="username">username</label>
            <input id="username" name="username">
            <label for="password">password</label>
            <input id="password" name="password">
            <button id="update-cache">Update cache</button>
            <span class="warn">Note: Slow!</span>
        </form>
    </div>

    <div class="wrapper">
        <p>Filter reviews/stats below:</p>
        <div>
            <span>since (yyyy-mm-dd): </span> <input id="sinceDate" value="2012-01-01" />
            <span>min comments: </span> <input id="minComments" value="0" />
            <span>authors: </span> <input id="authors" value="" />        
        </div>
        <span>excluded projects: </span> <input id="excludedProjects" value="" />
        <span>included projects: </span> <input id="includedProjects" value="" />        
    </div>

    <div class="wrapper">
        <h1>Monthly stats:</h1>
        <table cellpadding="0" cellspacing="0" border="0" class="display" id="reviews-per-month"></table>
    </div>

    <div class="wrapper">
        <h1>User stats:</h1>
        <table cellpadding="0" cellspacing="0" border="0" class="display" id="userstats"></table>
    </div>
        
    <div class="wrapper">
        <h1>Reviews:</h1>
        <table cellpadding="0" cellspacing="0" border="0" class="display" id="reviews"></table>
    </div>
        
</body>
</html>